<!DOCTYPE html>
<html dir="ltr" lang="en-US">

<head>
    <meta charset="utf-8">
    <meta content="IE=edge" http-equiv="X-UA-Compatible">
    <meta content="width=device-width, initial-scale=1" name="viewport">


    <!-- ===============================================-->
    <!--    Document Title-->
    <!-- ===============================================-->
    <title>Make sale - own store</title>
    {% load static %}


    <!-- ===============================================-->
    <!--    Favicons-->
    <!-- ===============================================-->
    <link href="{% static 'img/favicons/apple-touch-icon.png' %}" rel="apple-touch-icon" sizes="180x180">
    <link href="{% static 'img/favicons/favicon-32x32.png' %}" rel="icon" sizes="32x32" type="image/png">
    <link href="{% static 'img/favicons/favicon-16x16.png' %}" rel="icon" sizes="16x16" type="image/png">
    <link href="{% static 'img/favicons/favicon.ico' %}" rel="shortcut icon" type="image/x-icon">
    <link href="{% static 'img/favicons/manifest.json' %}" rel="manifest">
    <meta content="{% static 'img/favicons/mstile-150x150.png' %}" name="msapplication-TileImage">
    <meta content="#ffffff" name="theme-color">
    <script src="{% static 'vendors/imagesloaded/imagesloaded.pkgd.min.js' %}"></script>
    <script src="{% static 'vendors/simplebar/simplebar.min.js' %}"></script>
    <script src="{% static 'js/config.js' %}"></script>

    <!-- ===============================================-->
    <!--    Stylesheets-->
    <!-- ===============================================-->
    <link href="{% static 'vendors/flatpickr/flatpickr.min.css' %}" rel="stylesheet">
    <link href="{% static 'vendors/choices/choices.min.css' %}" rel="stylesheet">
    <link href="{% static 'vendors/prism/prism-okaidia.css' %}" rel="stylesheet">
    <link href="https://fonts.googleapis.com" rel="preconnect">
    <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect">
    <link href="https://fonts.googleapis.com/css2?family=Nunito+Sans:wght@300;400;600;700;800;900&amp;display=swap"
          rel="stylesheet">
    <link href="{% static 'vendors/simplebar/simplebar.min.css' %}" rel="stylesheet">
    <link href="https://unicons.iconscout.com/release/v4.0.0/css/line.css" rel="stylesheet">
    <link href="{% static 'css/theme-rtl.min.css' %}" id="style-rtl" rel="stylesheet" type="text/css">
    <link href="{% static 'css/theme.min.css' %}" id="style-default" rel="stylesheet" type="text/css">
    <link href="{% static 'css/user-rtl.min.css' %}" id="user-style-rtl" rel="stylesheet" type="text/css">
    <link href="{% static 'css/user.min.css' %}" id="user-style-default" rel="stylesheet" type="text/css">

    <script>
      var isRTL = JSON.parse(localStorage.getItem('isRTL'));
      if (isRTL) {
        var linkDefault = document.getElementById('style-default');
        var userLinkDefault = document.getElementById('user-style-default');
        linkDefault.setAttribute('disabled', true);
        userLinkDefault.setAttribute('disabled', true);
        document.querySelector('html').setAttribute('dir', 'rtl');
      } else {
        var linkRTL = document.getElementById('style-rtl');
        var userLinkRTL = document.getElementById('user-style-rtl');
        linkRTL.setAttribute('disabled', true);
        userLinkRTL.setAttribute('disabled', true);
      }



















    </script>
</head>


<body>

<!-- ===============================================-->
<!--    Main Content-->
<!-- ===============================================-->
<main class="main" id="top">
    <div class="container-fluid px-0">
        {% include 'nav_bar_store.html' %}

        <div class="content">
            <form>
                <input name="cartData">
                <input name="customerData">
                <input name="billingDetailsData">
            </form>
            <div class="col-12 col-xxl-6">
                <div class="card shadow-none border border-300 my-4" data-component-card="data-component-card">
                    <div class="card-header p-4 border-bottom border-300 bg-soft">
                        <div class="row g-3 justify-content-between align-items-center">
                            <div class="col-12 col-md">
                                <h4 class="text-900 mb-0" data-anchor="data-anchor">Make a sale</h4>
                            </div>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div class="p-4 code-to-copy">
                            <div class="card theme-wizard mb-5" data-theme-wizard="data-theme-wizard">
                                <div class="card-header bg-100 pt-3 pb-2 border-bottom-0">
                                    <ul class="nav justify-content-between nav-wizard">
                                        <li class="nav-item"><a class="nav-link active fw-semi-bold"
                                                                href="#bootstrap-wizard-validation-tab1"
                                                                data-bs-toggle="tab" data-wizard-step="1">
                                            <div class="text-center d-inline-block"><span
                                                    class="nav-item-circle-parent"><span class="nav-item-circle"><span
                                                    class="fas fa-shopping-cart"></span></span></span><span
                                                    class="d-none d-md-block mt-1 fs--1">Products</span></div>
                                        </a></li>

                                        <li class="nav-item"><a class="nav-link fw-semi-bold"
                                                                href="#bootstrap-wizard-validation-tab2"
                                                                data-bs-toggle="tab" data-wizard-step="2">
                                            <div class="text-center d-inline-block"><span
                                                    class="nav-item-circle-parent"><span class="nav-item-circle"><span
                                                    class="fas fa-user"></span></span></span><span
                                                    class="d-none d-md-block mt-1 fs--1">Customer</span></div>
                                        </a></li>
                                        <li class="nav-item"><a class="nav-link fw-semi-bold"
                                                                href="#bootstrap-wizard-validation-tab3"
                                                                data-bs-toggle="tab" data-wizard-step="3">
                                            <div class="text-center d-inline-block"><span
                                                    class="nav-item-circle-parent"><span class="nav-item-circle"><span
                                                    class="fas fa-file-invoice-dollar"></span></span></span><span
                                                    class="d-none d-md-block mt-1 fs--1">Billing details</span></div>
                                        </a></li>

                                        <li class="nav-item"><a class="nav-link fw-semi-bold"
                                                                href="#bootstrap-wizard-validation-tab4"
                                                                data-bs-toggle="tab" data-wizard-step="4">
                                            <div class="text-center d-inline-block"><span
                                                    class="nav-item-circle-parent"><span class="nav-item-circle"><span
                                                    class="fas fa-eye"></span></span></span><span
                                                    class="d-none d-md-block mt-1 fs--1">Review</span></div>
                                        </a></li>
                                    </ul>
                                </div>

                                <div class="card-body pt-4 pb-0">
                                    <div class="tab-content">
                                        <!--                            tab 1-->
                                        <div class="tab-pane active" role="tabpanel"
                                             aria-labelledby="bootstrap-wizard-validation-tab1"
                                             id="bootstrap-wizard-validation-tab1">
                                            <form class="needs-validation" id="wizardValidationForm1"
                                                  novalidate="novalidate" data-wizard-form="1">
                                                <div id="products_container">
                                                    <!-- product card starts here generated dynamically -->
                                                    <!-- product card ends here-->
                                                </div>

                                                <div class="flex-1 text-end">
                                                    <a class="btn btn-primary px-6 px-sm-6"
                                                       onclick="createProductCard()">Add product
                                                    </a>
                                                </div>
                                            </form>
                                        </div>
                                        <div class="tab-pane" role="tabpanel"
                                             aria-labelledby="bootstrap-wizard-validation-tab2"
                                             id="bootstrap-wizard-validation-tab2">
                                            <form class="needs-validation" id="wizardValidationForm2"
                                                  novalidate="novalidate" data-wizard-form="2">
                                                <h1>1</h1>
                                            </form>
                                        </div>
                                        <div class="tab-pane" role="tabpanel"
                                             aria-labelledby="bootstrap-wizard-validation-tab3"
                                             id="bootstrap-wizard-validation-tab3">
                                            <form class="mb-2 needs-validation" id="wizardValidationForm3"
                                                  novalidate="novalidate" data-wizard-form="3">
                                                <h1>2</h1>
                                            </form>
                                        </div>
                                        <div class="tab-pane" role="tabpanel"
                                             aria-labelledby="bootstrap-wizard-validation-tab4"
                                             id="bootstrap-wizard-validation-tab4">
                                            <div class="row flex-center pb-8 pt-4 gx-3 gy-4">
                                                <div class="col-12 col-sm-auto">
                                                    <div class="text-center text-sm-start"><img class="d-dark-none"
                                                                                                src="../../assets/img/spot-illustrations/34.png"
                                                                                                alt="" width="220"/><img
                                                            class="d-light-none"
                                                            src="../../assets/img/spot-illustrations/dark_34.png" alt=""
                                                            width="220"/></div>
                                                </div>
                                                <div class="col-12 col-sm-auto">
                                                    <div class="text-center text-sm-start">
                                                        <h5 class="mb-3">You are all set!</h5>
                                                        <p class="text-1100 fs--1">Now you can access your account<br/>anytime
                                                            anywhere</p><a class="btn btn-primary px-6"
                                                                           href="../../modules/forms/wizard.html">Start
                                                        Over</a>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                    </div>
                                </div>
                                <div class="card-footer border-top-0" data-wizard-footer="data-wizard-footer">
                                    <div class="d-flex pager wizard list-inline mb-0">
                                        <button class="d-none btn btn-link ps-0" type="button"
                                                data-wizard-prev-btn="data-wizard-prev-btn"><span
                                                class="fas fa-chevron-left me-1" data-fa-transform="shrink-3"></span>Previous
                                        </button>
                                        <div class="flex-1 text-end">
                                            <button class="btn btn-primary px-6 px-sm-6" type="submit"
                                                    data-wizard-next-btn="data-wizard-next-btn">Next<span
                                                    class="fas fa-chevron-right ms-1"
                                                    data-fa-transform="shrink-3"> </span></button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            {% include 'footer.html' %}

        </div>
    </div>
    <script>
        var navbarTopStyle = localStorage.getItem('phoenixNavbarTopStyle');
        var navbarTop = document.querySelector('.navbar-top');
        if (navbarTopStyle === 'darker') {
          navbarTop.classList.add('navbar-darker');
        }

        var navbarVerticalStyle = localStorage.getItem('phoenixNavbarVerticalStyle');
        var navbarVertical = document.querySelector('.navbar-vertical');
        if (navbarVerticalStyle === 'darker') {
          navbarVertical.classList.add('navbar-darker');
        }


    </script>
</main>
<!-- ===============================================-->
<!--    End of Main Content-->
<!-- ===============================================-->

<!-- ===============================================-->
<!--    JavaScripts-->
<!-- ===============================================-->
<script src="{% static 'vendors/popper/popper.min.js' %}"></script>
<script src="{% static 'vendors/bootstrap/bootstrap.min.js' %}"></script>
<script src="{% static 'vendors/anchorjs/anchor.min.js' %}"></script>
<script src="{% static 'vendors/is/is.min.js' %}"></script>
<script src="{% static 'vendors/fontawesome/all.min.js' %}"></script>
<script src="{% static 'vendors/lodash/lodash.min.js' %}"></script>
<script src="https://polyfill.io/v3/polyfill.min.js?features=window.scroll"></script>
<script src="{% static 'vendors/list.js/list.min.js' %}"></script>
<script src="{% static 'vendors/feather-icons/feather.min.js' %}"></script>
<script src="{% static 'vendors/dayjs/dayjs.min.js' %}"></script>
<script src="{% static 'vendors/choices/choices.min.js' %}"></script>
<script src="{% static 'vendors/prism/prism.js' %}"></script>
<script src="{% static 'js/phoenix.js' %}"></script>
{# Include the JSON-encoded stocks_list data #}
{{ stocks_list|json_script:"stocksList" }}


<script>
    let productCardCount = 1;
    var stocks_list = JSON.parse(document.getElementById('stocksList').textContent);
    createProductCard();
    function createProductCard() {
      // Create a new product card element
      let productCard = document.createElement("div");
      productCard.classList.add("product_widget", "card-header", "bg-100", "mb-4");

      // Build the product card structure dynamically
      productCard.innerHTML = `
         <div class="col text-end">
              <a type="button" class="text-danger" onclick="removeProductCard(this)">
                Remove <i class="fas fa-trash"></i>
              </a>
         </div>
        <div class="mb2 col-12">
          <h5 class="mb-3">Select Product</h5>
          <select onchange="updateProductFields(this, ${productCardCount})"
            class="form-select" data-choices="data-choices"
            data-options='{"removeItemButton":true,"placeholder":true}'
            name="product" required="required">
            <option value="">Select product</option>
            <!-- Populate options dynamically, e.g., from stocks_list -->
            {% for product in stocks_list %}
            <option value="{{product.product_id}}">{{product.product_name}}</option>
            {% endfor %}
          </select>
          <div class="custom-error" style="color: red;"></div>
        </div>
        <div id="product_info" class="row g-3 mb-3">
          <div class="mb2 col-4">
            <h5 class="mb-3">Product Category</h5>
            <input class="form-control" name="product_category[${productCardCount}]"
              placeholder="Category"
              required="required"
              type="text" value="" readonly/>
            <div class="invalid-feedback">This field is required.</div>
          </div>
          <div class="mb2 col-4">
            <h5 class="mb-3">Product Brand</h5>
            <input class="form-control" name="product_brand[${productCardCount}]"
              placeholder="Brand"
              required="required"
              type="text" value="" readonly/>
            <div class="invalid-feedback">This field is required.</div>
          </div>
          <!-- Add the rest of your product card HTML structure here -->
          <div class="mb2 col-4">
            <h5 class="mb-3">Product HSN</h5>
            <input class="form-control" name="product_hsn[${productCardCount}]"
              placeholder="HSN"
              required="required"
              type="text" value="" readonly/>
            <div class="invalid-feedback">This field is required.</div>
          </div>
          <div class="mb2 col-6">
            <h5 class="mb-3">Available Quantity</h5>
            <input class="form-control" name="available_qty[${productCardCount}]"
              placeholder="Available Quantity"
              required="required"
              type="text" value="" readonly/>
            <div class="invalid-feedback">This field is required.</div>
          </div>
          <div class="mb2 col-6">
            <h5 class="mb-3">Unit Price</h5>
            <input class="form-control" name="unit_price[${productCardCount}]"
              placeholder="Unit Price"
              required="required"
              type="text" value="" readonly/>
            <div class="invalid-feedback">This field is required.</div>
          </div>
          <div class="mb2 col-6">
            <h5 class="mb-3">Purchase Quantity</h5>
            <input class="form-control" name="purchase_qty[${productCardCount}]"
              placeholder="Purchase quantity"
              required="required"
              type="number"
              min="1"
              type="text" value=""/>
            <div class="invalid-feedback">This field should be 1 in minimum and should be less than available quantity.</div>
          </div>
          <div class="mb2 col-6">
            <h5 class="mb-3">Product Total</h5>
            <input class="form-control" name="product_total[${productCardCount}]"
              placeholder="Product Total"
              required="required"
              type="text" value="0" readonly/>
            <div class="invalid-feedback">This field is required.</div>
          </div>
          <div id="discount_check_div[${productCardCount}]" class="form-check" style="display:none">
                 <input  id="discount_value_field[${productCardCount}]" type="hidden" name="discount_percentage[${productCardCount}]" required="required" readonly/>
                 <input class="form-check-input" type="checkbox" name="discount_checked[${productCardCount}]" id="bootstrap-wizard-validation-wizard-checkbox" />
                 <label id="discount_value[${productCardCount}]" class="form-check-label text-900" for="bootstrap-wizard-validation-wizard-checkbox"></label>
          </div>
        </div>
      `;

      // Append the product card to the products container
      document.querySelector("#products_container").appendChild(productCard);

      // Optionally, you can now initialize any JavaScript plugins for the new card
      // For example, if you're using Choices.js:
      let choicesInstance = new Choices(productCard.querySelector("[name='product']"), {
        // Pass any necessary options for Choices.js
        removeItemButton: true,
        placeholder: true,
      });

      productCardCount++;
      let jsonData = getFormData();
      
    }

    function updateProductFields(selectElement, cardIndex) {
      // Update duplicated product categories and brands within the same segment
      let selectedIndex = selectElement.selectedIndex;

      let selectedProduct = stocks_list.find(product => product.product_id == selectElement.value);

      let productCategoryField = document.querySelector(`[name='product_category[${cardIndex}]']`);
      let productBrandField = document.querySelector(`[name='product_brand[${cardIndex}]']`);
      let productSkuField = document.querySelector(`[name='product_hsn[${cardIndex}]']`);
      let productAvailableQtyField = document.querySelector(`[name='available_qty[${cardIndex}]']`);
      let productUnitPriceField = document.querySelector(`[name='unit_price[${cardIndex}]']`);
      let productPurchaseQtyField = document.querySelector(`[name='purchase_qty[${cardIndex}]']`);
      let productProductTotalField = document.querySelector(`[name='product_total[${cardIndex}]']`);
      let productDiscountCheckedField = document.querySelector(`[name='discount_checked[${cardIndex}]']`);
      let discountCheckDiv = document.getElementById('discount_check_div[' + cardIndex + ']');
      let discountValueText = document.getElementById('discount_value[' + cardIndex + ']');
      let discountValueField = document.getElementById('discount_value_field[' + cardIndex + ']');
      let discountCheckbox = document.querySelector(`[name='discount_checked[${cardIndex}]']`);



      productCategoryField.value = selectedProduct.category_name;
      productBrandField.value = selectedProduct.brand_name;
      productSkuField.value = selectedProduct.hsn;
      productAvailableQtyField.value = selectedProduct.product_quantity;
      productUnitPriceField.value = selectedProduct.sale_price;
      productPurchaseQtyField.value = '';
      productPurchaseQtyField.max = selectedProduct.product_quantity;
      productProductTotalField.value = '';

      if(selectedProduct.discount>0){
          discountCheckDiv.style.display = 'block';
          discountValueText.innerHTML = '<h5>Discount available !</h5> Apply discount : '+selectedProduct.discount+'%';
          discountValueField.value = selectedProduct.discount;
      }else{
          discountCheckDiv.style.display = 'none';
      }

      productPurchaseQtyField.addEventListener('input', function () {
      let purchaseQty = parseFloat(productPurchaseQtyField.value) || 0;
      let productTotal;
      if (discountCheckbox.checked) {
        // Apply discount if the checkbox is checked
        let discountPercentage = parseFloat(discountValueField.value) || 0;
        let discountedPrice = selectedProduct.sale_price * (1 - discountPercentage / 100);
        productTotal = purchaseQty * discountedPrice;
      } else {
        // No discount, use the original sale price
        productTotal = purchaseQty * parseFloat(selectedProduct.sale_price) || 0;
      }
      productProductTotalField.value = productTotal.toFixed(2);
      let jsonData = getFormData();
      
      });

      discountCheckbox.addEventListener('change', function () {
            let isChecked = discountCheckbox.checked;
            if (isChecked) {
                let discountPercentage = parseFloat(discountValueField.value) || 0;
                let discountedPrice = selectedProduct.sale_price * (1 - discountPercentage / 100);
                productProductTotalField.value = (discountedPrice*productPurchaseQtyField.value).toFixed(2);
            } else {
                productProductTotalField.value = (selectedProduct.sale_price*productPurchaseQtyField.value).toFixed(2);
                productProductTotalField.innerHTML = '';
            }
            let jsonData = getFormData();
            
      });
      let jsonData = getFormData();
      
    }
    function removeProductCard(removeButton) {
        // Find the parent product card and remove it
        let productCard = removeButton.closest(".product_widget");
        if (productCard) {
            productCard.remove();
        }
        let jsonData = getFormData();
    }

function getFormData() {
  let formData = [];
  let cartDataField = document.querySelector(`[name='cartData']`);

  // Iterate through all product cards
  let productCards = document.querySelectorAll('.product_widget');
  productCards.forEach((productCard, index) => {
    let productData = {};

    // Iterate through all form elements within the product card
    let formElements = productCard.querySelectorAll('input, select');
    formElements.forEach((element) => {
      let key = element.name;
      let value = element.value;

      // Include all elements, including hidden fields, and set discount_checked to "off" if hidden or unchecked
      if (key !== undefined && key !== null && key !== "") {
        if (element.type === 'checkbox' && !element.checked) {
          productData[key] = 'off';
        } else {
          productData[key] = value;
        }
      }
    });

    // Add productData to formData array
    formData.push(productData);
  });

  // Convert formData array to JSON string
  let jsonData = JSON.stringify(formData);

  // Set the JSON string as the value of cartDataField
  cartDataField.value = jsonData;

  return formData;
}



</script>


</body>

</html>